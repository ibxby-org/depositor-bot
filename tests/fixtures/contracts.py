from typing import cast

import pytest

import variables
from blockchain.contracts.deposit_security_module import DepositSecurityModuleContract, DepositSecurityModuleContractV2
from blockchain.contracts.lido import LidoContract
from blockchain.contracts.lido_locator import LidoLocatorContract
from blockchain.contracts.deposit import DepositContract
from blockchain.contracts.staking_router import StakingRouterContract
from blockchain.typings import Web3


@pytest.fixture
def lido_locator(web3_provider_integration):
    yield cast(LidoLocatorContract, web3_provider_integration.eth.contract(
        address=variables.LIDO_LOCATOR,
        ContractFactoryClass=LidoLocatorContract,
    ))


@pytest.fixture
def deposit_contract(web3_provider_integration):
    yield cast(DepositContract, web3_provider_integration.eth.contract(
        address=variables.DEPOSIT_CONTRACT,
        ContractFactoryClass=DepositContract,
    ))


@pytest.fixture
def lido_contract(web3_provider_integration, lido_locator):
    yield cast(LidoContract, web3_provider_integration.eth.contract(
        address=lido_locator.lido(),
        ContractFactoryClass=LidoContract,
    ))


@pytest.fixture
def deposit_security_module(web3_provider_integration, lido_locator):
    yield cast(DepositSecurityModuleContract, web3_provider_integration.eth.contract(
        address=lido_locator.deposit_security_module(),
        ContractFactoryClass=DepositSecurityModuleContract,
    ))


@pytest.fixture
def deposit_security_module_v2(web3_lido_integration, lido_locator):
    upgrade_staking_router_to_v2(web3_lido_integration)
    yield cast(DepositSecurityModuleContractV2, web3_lido_integration.eth.contract(
        address=lido_locator.deposit_security_module(),
        ContractFactoryClass=DepositSecurityModuleContractV2,
    ))


@pytest.fixture
def staking_router(web3_provider_integration, lido_locator):
    yield cast(StakingRouterContract, web3_provider_integration.eth.contract(
        address=lido_locator.staking_router(),
        ContractFactoryClass=StakingRouterContract,
    ))


DSM_V2_BYTECODE = '0x60a06040527f2dd9727393562ed11c29080a884630e2d3a7078e71b313e713a8a1ef68948f6a608052600360055560e160068190556007819055600855600d805460ff1916905534801561005257600080fd5b50608051611b7561006e60003960006102d40152611b756000f3fe608060405234801561001057600080fd5b50600436106101ce5760003560e01c80635c287a2511610104578063b7b7a408116100a2578063c8f712d511610071578063c8f712d5146103b7578063eccd085f146103ca578063f47610e6146103dd578063ffa1ad74146103f057600080fd5b8063b7b7a4081461038b578063c6dda2c314610393578063c7062e981461039c578063c8a5f8e6146103a457600080fd5b8063893d20e8116100de578063893d20e81461034b5780638b21f1701461035c5780638d71a6f41461036f578063a50833d61461038257600080fd5b80635c287a25146102f65780636b96736b1461030d5780637e9233121461033857600080fd5b8063251e3a21116101715780633ab54bc31161014b5780633ab54bc3146102965780633bab964e146102a95780633e6f6d68146102bc5780634d72ba86146102cf57600080fd5b8063251e3a211461027057806327042b841461027857806339443b8e1461028357600080fd5b80630c68ba21116101ad5780630c68ba21146102145780630df9a86d14610237578063111e53131461024a57806313af40351461025d57600080fd5b8062fed902146101d3578063062b662e146101e85780630665f04b146101ff575b600080fd5b6101e66101e136600461156b565b6103f9565b005b600a545b6040519081526020015b60405180910390f35b610207610437565b6040516101f69190611584565b6102276102223660046115ed565b610499565b60405190151581526020016101f6565b6101e661024536600461165b565b6104bb565b6101e661025836600461172b565b61087a565b6101e661026b3660046115ed565b6108bd565b6007546101ec565b600d5460ff16610227565b61022761029136600461156b565b6108f3565b6101e66102a43660046117eb565b610b3f565b6101e66102b736600461156b565b610b7b565b6101e66102ca36600461156b565b610cba565b6101ec7f000000000000000000000000000000000000000000000000000000000000000081565b6101e66103043660046118a7565b50505050505050565b600454610320906001600160a01b031681565b6040516001600160a01b0390911681526020016101f6565b6101e661034636600461156b565b610cf0565b6009546001600160a01b0316610320565b600254610320906001600160a01b031681565b6101e661037d36600461172b565b610d26565b6101ec60015481565b6006546101ec565b6101ec60005481565b6008546101ec565b600354610320906001600160a01b031681565b6101e66103c5366004611944565b610ed5565b6101e66103d836600461156b565b610f4a565b6101ec6103eb3660046115ed565b610f80565b6101ec60055481565b6009546001600160a01b0316331461042b5760405163351c880f60e01b81523360048201526024015b60405180910390fd5b61043481610f8b565b50565b6060600b80548060200260200160405190810160405280929190818152602001828054801561048f57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610471575b5050505050905090565b6001600160a01b0381166000908152600c602052604081205415155b92915050565b600a5415806104cb5750600a5481105b156104e957604051630833b4e360e41b815260040160405180910390fd5b6000600460009054906101000a90046001600160a01b03166001600160a01b031663c5f2892f6040518163ffffffff1660e01b815260040160206040518083038186803b15801561053957600080fd5b505afa15801561054d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061057191906119e2565b9050808814610593576040516302d654b160e41b815260040160405180910390fd5b600354604051636608b11b60e01b8152600481018990526001600160a01b0390911690636608b11b9060240160206040518083038186803b1580156105d757600080fd5b505afa1580156105eb573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061060f91906119fb565b61062c5760405163fa7f287160e01b815260040160405180910390fd5b60035460405163473e043360e01b8152600481018990526000916001600160a01b03169063473e04339060240160206040518083038186803b15801561067157600080fd5b505afa158015610685573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106a991906119e2565b6007549091506106b98243611a33565b10156106d857604051633ec3745360e11b815260040160405180910390fd5b8915806106e65750898b4014155b15610704576040516328aada8b60e21b815260040160405180910390fd5b600354604051630519fbbf60e01b8152600481018a90526000916001600160a01b031690630519fbbf9060240160206040518083038186803b15801561074957600080fd5b505afa15801561075d573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061078191906119e2565b90508088146107a357604051632e8f7e7360e11b815260040160405180910390fd5b6108038a8d8d8c8c8a8a808060200260200160405190810160405280939291908181526020016000905b828210156107f9576107ea60408302860136819003810190611a4a565b815260200190600101906107cd565b5050505050610fc7565b60025460065460405163aa0b7db760e01b81526001600160a01b039092169163aa0b7db79161083a918d908c908c90600401611a66565b600060405180830381600087803b15801561085457600080fd5b505af1158015610868573d6000803e3d6000fd5b50505050505050505050505050505050565b6009546001600160a01b031633146108a75760405163351c880f60e01b8152336004820152602401610422565b6108b0826110f6565b6108b98161120a565b5050565b6009546001600160a01b031633146108ea5760405163351c880f60e01b8152336004820152602401610422565b61043481611248565b6003546040516329cd0ca760e21b8152600481018390526000916001600160a01b03169063a734329c9060240160206040518083038186803b15801561093857600080fd5b505afa15801561094c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061097091906119fb565b61097c57506000919050565b600354604051636608b11b60e01b8152600481018490526000916001600160a01b031690636608b11b9060240160206040518083038186803b1580156109c157600080fd5b505afa1580156109d5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109f991906119fb565b60035460405163473e043360e01b8152600481018690529192506000916001600160a01b039091169063473e04339060240160206040518083038186803b158015610a4357600080fd5b505afa158015610a57573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a7b91906119e2565b90506000600260009054906101000a90046001600160a01b03166001600160a01b031663e78a58756040518163ffffffff1660e01b815260040160206040518083038186803b158015610acd57600080fd5b505afa158015610ae1573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b0591906119fb565b9050828015610b1657506000600a54115b8015610b2d5750600754610b2a8343611a33565b10155b8015610b365750805b95945050505050565b60405133907feb225a736fbfee3f85ccb72bdf84ff0396ab358b7970e2cc351ab3e3fd92358d90600090a25050600d805460ff19166001179055565b6009546001600160a01b03163314610ba85760405163351c880f60e01b8152336004820152602401610422565b60035460405163e24ce9f160e01b8152600481018390526001600160a01b039091169063e24ce9f19060240160206040518083038186803b158015610bec57600080fd5b505afa158015610c00573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c2491906119fb565b1561043457600354604051633618716160e21b8152600481018390526001600160a01b039091169063d861c58490602401600060405180830381600087803b158015610c6f57600080fd5b505af1158015610c83573d6000803e3d6000fd5b505060405162ffffff841692507fb861fabb6dfce807f39e6f400693b8a826dcd89a4ce4ff8e955f6c4ddec398a39150600090a250565b6009546001600160a01b03163314610ce75760405163351c880f60e01b8152336004820152602401610422565b6104348161120a565b6009546001600160a01b03163314610d1d5760405163351c880f60e01b8152336004820152602401610422565b610434816112d9565b6009546001600160a01b03163314610d535760405163351c880f60e01b8152336004820152602401610422565b6001600160a01b0382166000908152600c602052604090205480610d95576040516302333ca160e51b81526001600160a01b0384166004820152602401610422565b600b5480821115610da857610da8611aa3565b808214610e3e576000600b610dbe600184611a33565b81548110610dce57610dce611ab9565b6000918252602090912001546001600160a01b0316905080600b610df3600186611a33565b81548110610e0357610e03611ab9565b600091825260208083209190910180546001600160a01b0319166001600160a01b03948516179055929091168152600c909152604090208290555b6001600160a01b0384166000908152600c6020526040812055600b805480610e6857610e68611acf565b600082815260209020810160001990810180546001600160a01b0319169055019055610e938361120a565b6040516001600160a01b03851681527fb8107d0c6b40be480ce3172ee66ba6d64b71f6b1685a851340036e6e2e3e3c529060200160405180910390a150505050565b6009546001600160a01b03163314610f025760405163351c880f60e01b8152336004820152602401610422565b60005b8251811015610f4057610f30838281518110610f2357610f23611ab9565b60200260200101516110f6565b610f3981611ae5565b9050610f05565b506108b98161120a565b6009546001600160a01b03163314610f775760405163351c880f60e01b8152336004820152602401610422565b61043481611365565b60006104b5826113e8565b60068190556040518181527f4d72502b63cfe737b98b225a53708fe347cf8274baed31e0c4e4941b758da992906020015b60405180910390a150565b600080546040805160208101929092528101879052606081018690526080810188905260a0810185905260c0810184905260e0016040516020818303038152906040528051906020012090506000805b83518110156110eb5760006110678486848151811061103857611038611ab9565b60200260200101516000015187858151811061105657611056611ab9565b60200260200101516020015161140d565b905061108a816001600160a01b03166000908152600c6020526040902054151590565b6110a757604051638baa579f60e01b815260040160405180910390fd5b826001600160a01b0316816001600160a01b0316116110d9576040516301eba55160e01b815260040160405180910390fd5b91506110e481611ae5565b9050611017565b505050505050505050565b6001600160a01b03811661113c5760405163eac0d38960e01b815260206004820152600c60248201526b2fb732bba3bab0b93234b0b760a11b6044820152606401610422565b6001600160a01b0381166000908152600c60205260409020541561117e57604051639f2277f360e01b81526001600160a01b0382166004820152602401610422565b600b80546001810182557f0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db90180546001600160a01b0319166001600160a01b03841690811790915590546000828152600c602090815260409182902092909255519182527f038596bb31e2e7d3d9f184d4c98b310103f6d7f5830e5eec32bffe6f1728f9699101610fbc565b80600a541461043457600a8190556040518181527f70d7432f2ec830b36e5b8c45176a8079968714429c4be85665c06ec1b8fde4bb90602001610fbc565b6001600160a01b03811661128b5760405163eac0d38960e01b81526020600482015260096024820152682fb732bba7bbb732b960b91b6044820152606401610422565b600980546001600160a01b0319166001600160a01b0383169081179091556040519081527fa2ea9883a321a3e97b8266c2b078bfeec6d50c711ed71f874a90d500ae2eaf3690602001610fbc565b8061132757604051631fd43b6f60e21b815260206004820152601760248201527f6d696e4465706f736974426c6f636b44697374616e63650000000000000000006044820152606401610422565b60075481146104345760078190556040518181527fdb69cbc4aa6648b506b7854c26807bfd811c27feaf97ac8847e3a66356cace1490602001610fbc565b806113b357604051631fd43b6f60e21b815260206004820152601f60248201527f7061757365496e74656e7456616c6964697479506572696f64426c6f636b73006044820152606401610422565b60088190556040518181527f8120886d27fee35672e5d5a482d6c858105aebb26caf12178b8c0034fa88c2ba90602001610fbc565b6001600160a01b0381166000908152600c60205260408120546104b590600190611b00565b60006001600160ff1b03821660ff83901c601b0161142d86828785611437565b9695505050505050565b60007f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a08211156114b45760405162461bcd60e51b815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202773272076616c604482015261756560f01b6064820152608401610422565b6040805160008082526020820180845288905260ff871692820192909252606081018590526080810184905260019060a0016020604051602081039080840390855afa158015611508573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116610b365760405162461bcd60e51b815260206004820152601860248201527f45434453413a20696e76616c6964207369676e617475726500000000000000006044820152606401610422565b60006020828403121561157d57600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b818110156115c55783516001600160a01b0316835292840192918401916001016115a0565b50909695505050505050565b80356001600160a01b03811681146115e857600080fd5b919050565b6000602082840312156115ff57600080fd5b611608826115d1565b9392505050565b60008083601f84011261162157600080fd5b50813567ffffffffffffffff81111561163957600080fd5b6020830191508360208260061b850101111561165457600080fd5b9250929050565b600080600080600080600080600060e08a8c03121561167957600080fd5b8935985060208a0135975060408a0135965060608a0135955060808a0135945060a08a013567ffffffffffffffff808211156116b457600080fd5b818c0191508c601f8301126116c857600080fd5b8135818111156116d757600080fd5b8d60208285010111156116e957600080fd5b6020830196508095505060c08c013591508082111561170757600080fd5b506117148c828d0161160f565b915080935050809150509295985092959850929598565b6000806040838503121561173e57600080fd5b611747836115d1565b946020939093013593505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561179457611794611755565b604052919050565b6000604082840312156117ae57600080fd5b6040516040810181811067ffffffffffffffff821117156117d1576117d1611755565b604052823581526020928301359281019290925250919050565b600080606083850312156117fe57600080fd5b8235915061180f846020850161179c565b90509250929050565b600067ffffffffffffffff82111561183257611832611755565b5060051b60200190565b600082601f83011261184d57600080fd5b8135602061186261185d83611818565b61176b565b82815260059290921b8401810191818101908684111561188157600080fd5b8286015b8481101561189c5780358352918301918301611885565b509695505050505050565b6000806000806000806000610100888a0312156118c357600080fd5b87359650602088013595506040880135945060608801359350608088013567ffffffffffffffff808211156118f757600080fd5b6119038b838c0161183c565b945060a08a013591508082111561191957600080fd5b506119268a828b0161183c565b9250506119368960c08a0161179c565b905092959891949750929550565b6000806040838503121561195757600080fd5b823567ffffffffffffffff81111561196e57600080fd5b8301601f8101851361197f57600080fd5b8035602061198f61185d83611818565b82815260059290921b830181019181810190888411156119ae57600080fd5b938201935b838510156119d3576119c4856115d1565b825293820193908201906119b3565b98969091013596505050505050565b6000602082840312156119f457600080fd5b5051919050565b600060208284031215611a0d57600080fd5b8151801515811461160857600080fd5b634e487b7160e01b600052601160045260246000fd5b600082821015611a4557611a45611a1d565b500390565b600060408284031215611a5c57600080fd5b611608838361179c565b84815283602082015260606040820152816060820152818360808301376000818301608090810191909152601f909201601f191601019392505050565b634e487b7160e01b600052600160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052603160045260246000fd5b6000600019821415611af957611af9611a1d565b5060010190565b60008083128015600160ff1b850184121615611b1e57611b1e611a1d565b6001600160ff1b0384018313811615611b3957611b39611a1d565b5050039056fea2646970667358221220a7e57e075a66b764ce3b97ff8d5b9bbf89a1532835f99a890aa670f04c57a34364736f6c63430008090033'
LIDO_LOCATOR_BYTECODE = '0x6102406040523480156200001257600080fd5b5060405162000a3238038062000a32833981016040819052620000359162000254565b80516200004290620001d1565b6001600160a01b031660805260208101516200005e90620001d1565b6001600160a01b031660a05260408101516200007a90620001d1565b6001600160a01b031660c05260608101516200009690620001d1565b6001600160a01b031660e0526080810151620000b290620001d1565b6001600160a01b03166101005260a0810151620000cf90620001d1565b6001600160a01b03166101205260c0810151620000ec90620001d1565b6001600160a01b03166101405260e08101516200010990620001d1565b6001600160a01b0316610160526101008101516200012790620001d1565b6001600160a01b0316610180526101208101516200014590620001d1565b6001600160a01b03166101a0526101408101516200016390620001d1565b6001600160a01b03166101c0526101608101516200018190620001d1565b6001600160a01b03166101e0526101808101516200019f90620001d1565b6001600160a01b0316610200526101a0810151620001bd90620001d1565b6001600160a01b0316610220525062000383565b60006001600160a01b038216620001fb5760405163d92e233d60e01b815260040160405180910390fd5b5090565b6040516101c081016001600160401b03811182821017156200023157634e487b7160e01b600052604160045260246000fd5b60405290565b80516001600160a01b03811681146200024f57600080fd5b919050565b60006101c082840312156200026857600080fd5b62000272620001ff565b6200027d8362000237565b81526200028d6020840162000237565b6020820152620002a06040840162000237565b6040820152620002b36060840162000237565b6060820152620002c66080840162000237565b6080820152620002d960a0840162000237565b60a0820152620002ec60c0840162000237565b60c0820152620002ff60e0840162000237565b60e08201526101006200031481850162000237565b908201526101206200032884820162000237565b908201526101406200033c84820162000237565b908201526101606200035084820162000237565b908201526101806200036484820162000237565b908201526101a06200037884820162000237565b908201529392505050565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e05161020051610220516105ac6200048660003960006103f501526000818161026c015281816103980152610491015260008181610244015281816102a101526103700152600061010a01526000818161021c015261046a0152600081816101f2015261052d01526000818161017501526103480152600081816103c001526104df0152600081816101ca0152818161031e01526105540152600061014e015260006104b80152600081816101a5015281816102f601526105060152600061041c0152600081816102d1015261044301526105ac6000f3fe608060405234801561001057600080fd5b50600436106101005760003560e01c80635a2031f911610097578063d680a87611610066578063d680a876146104da578063e441d25f14610501578063ef6c064c14610528578063f5e6d50f1461054f57600080fd5b80635a2031f91461043e57806361d027b31461046557806369d421481461048c578063996107aa146104b357600080fd5b806337d5fe99116100d357806337d5fe991461029c5780633cbf357e146102c35780633fe7d554146103f0578063472c17761461041757600080fd5b806312f8d4b91461010557806323509a2d1461014957806327810b6e1461017057806335f4022e14610197575b600080fd5b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b604080516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000811682527f0000000000000000000000000000000000000000000000000000000000000000811660208301527f00000000000000000000000000000000000000000000000000000000000000008116928201929092527f0000000000000000000000000000000000000000000000000000000000000000821660608201527f0000000000000000000000000000000000000000000000000000000000000000821660808201527f00000000000000000000000000000000000000000000000000000000000000009190911660a082015260c001610140565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b604080516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000811682527f0000000000000000000000000000000000000000000000000000000000000000811660208301527f00000000000000000000000000000000000000000000000000000000000000008116928201929092527f0000000000000000000000000000000000000000000000000000000000000000821660608201527f0000000000000000000000000000000000000000000000000000000000000000821660808201527f0000000000000000000000000000000000000000000000000000000000000000821660a08201527f00000000000000000000000000000000000000000000000000000000000000009190911660c082015260e001610140565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f00000000000000000000000000000000000000000000000000000000000000008156fea2646970667358221220f56a7e9b46d8e22c7fbd5bfb01e236cd03fd8640f62ca4bf7a383de86337258d64736f6c63430008090033'


def upgrade_staking_router_to_v2(web3_lido_integration: Web3):
    contract = web3_lido_integration.eth.contract(
        abi=DepositSecurityModuleContractV2.load_abi(DepositSecurityModuleContractV2.abi_path),
        bytecode=DSM_V2_BYTECODE,
    )

    tx_hash = contract.constructor().transact()
    tx_receipt = web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)
    dsm_address = tx_receipt.contractAddress

    locator_contract = web3_lido_integration.eth.contract(
        abi=LidoLocatorContract.load_abi(LidoLocatorContract.abi_path),
        bytecode=LIDO_LOCATOR_BYTECODE,
    )

    tx_hash = locator_contract.constructor([
        web3_lido_integration.lido.lido_locator.functions.accountingOracle().call(),
        dsm_address,
        web3_lido_integration.lido.lido_locator.functions.elRewardsVault().call(),
        web3_lido_integration.lido.lido_locator.functions.legacyOracle().call(),
        web3_lido_integration.lido.lido_locator.functions.lido().call(),
        web3_lido_integration.lido.lido_locator.functions.oracleReportSanityChecker().call(),
        web3_lido_integration.lido.lido_locator.functions.postTokenRebaseReceiver().call(),
        web3_lido_integration.lido.lido_locator.functions.burner().call(),
        web3_lido_integration.lido.lido_locator.functions.stakingRouter().call(),
        web3_lido_integration.lido.lido_locator.functions.treasury().call(),
        web3_lido_integration.lido.lido_locator.functions.validatorsExitBusOracle().call(),
        web3_lido_integration.lido.lido_locator.functions.withdrawalQueue().call(),
        web3_lido_integration.lido.lido_locator.functions.withdrawalVault().call(),
        web3_lido_integration.lido.lido_locator.functions.oracleDaemonConfig().call(),
    ]).transact()
    tx_receipt = web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)
    new_locator = tx_receipt.contractAddress

    proxy = web3_lido_integration.eth.contract(
        address=variables.LIDO_LOCATOR,
        abi=web3_lido_integration.lido.lido_locator.load_abi('./interfaces/Proxy.json'),
    )

    admin = proxy.functions.proxy__getAdmin().call()

    web3_lido_integration.provider.make_request('anvil_setBalance', [admin, 10 ** 18])

    tx_hash = proxy.functions.proxy__upgradeTo(new_locator).transact({'from': admin})
    web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)

    assert web3_lido_integration.lido.has_contract_address_changed()
