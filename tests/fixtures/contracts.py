from typing import cast

import pytest

import variables
from blockchain.contracts.deposit_security_module import DepositSecurityModuleContract, DepositSecurityModuleContractV2
from blockchain.contracts.lido import LidoContract
from blockchain.contracts.lido_locator import LidoLocatorContract
from blockchain.contracts.deposit import DepositContract
from blockchain.contracts.staking_router import StakingRouterContract
from blockchain.typings import Web3


@pytest.fixture
def lido_locator(web3_provider_integration):
    yield cast(LidoLocatorContract, web3_provider_integration.eth.contract(
        address=variables.LIDO_LOCATOR,
        ContractFactoryClass=LidoLocatorContract,
    ))


@pytest.fixture
def deposit_contract(web3_provider_integration):
    yield cast(DepositContract, web3_provider_integration.eth.contract(
        address=variables.DEPOSIT_CONTRACT,
        ContractFactoryClass=DepositContract,
    ))


@pytest.fixture
def lido_contract(web3_provider_integration, lido_locator):
    yield cast(LidoContract, web3_provider_integration.eth.contract(
        address=lido_locator.lido(),
        ContractFactoryClass=LidoContract,
    ))


@pytest.fixture
def deposit_security_module(web3_provider_integration, lido_locator):
    yield cast(DepositSecurityModuleContract, web3_provider_integration.eth.contract(
        address=lido_locator.deposit_security_module(),
        ContractFactoryClass=DepositSecurityModuleContract,
    ))


@pytest.fixture
def deposit_security_module_v2(web3_provider_integration, lido_locator):
    upgrade_staking_router_to_v2(web3_provider_integration)
    yield cast(DepositSecurityModuleContractV2, web3_provider_integration.eth.contract(
        address=lido_locator.deposit_security_module(),
        ContractFactoryClass=DepositSecurityModuleContractV2,
    ))


@pytest.fixture
def staking_router(web3_provider_integration, lido_locator):
    yield cast(StakingRouterContract, web3_provider_integration.eth.contract(
        address=lido_locator.staking_router(),
        ContractFactoryClass=StakingRouterContract,
    ))


DSM_V2_BYTECODE = '0x60a06040527f2dd9727393562ed11c29080a884630e2d3a7078e71b313e713a8a1ef68948f6a60805260e160058190556006819055600755600c805460ff1916905534801561004d57600080fd5b50608051611b5461006960003960006102be0152611b546000f3fe608060405234801561001057600080fd5b50600436106101c35760003560e01c80636058fa91116100f9578063b7b7a40811610097578063c8a5f8e611610071578063c8a5f8e614610398578063c8f712d5146103ab578063eccd085f146103be578063f47610e6146103d157600080fd5b8063b7b7a4081461037f578063c6dda2c314610387578063c7062e981461039057600080fd5b8063893d20e8116100d3578063893d20e81461033f5780638b21f170146103505780638d71a6f414610363578063a50833d61461037657600080fd5b80636058fa91146102eb5780636b96736b146103015780637e9233121461032c57600080fd5b8063251e3a21116101665780633bab964e116101405780633bab964e146102935780633e6f6d68146102a65780634d72ba86146102b957806351ac3c39146102e057600080fd5b8063251e3a211461026557806339443b8e1461026d5780633ab54bc31461028057600080fd5b80630c68ba21116101a25780630c68ba21146102095780630df9a86d1461022c578063111e53131461023f57806313af40351461025257600080fd5b8062fed902146101c8578063062b662e146101dd5780630665f04b146101f4575b600080fd5b6101db6101d6366004611556565b6103e4565b005b6009545b6040519081526020015b60405180910390f35b6101fc610422565b6040516101eb919061156f565b61021c6102173660046115d8565b610484565b60405190151581526020016101eb565b6101db61023a366004611646565b6104a6565b6101db61024d366004611716565b610865565b6101db6102603660046115d8565b6108a8565b6006546101e1565b61021c61027b366004611556565b6108de565b6101db61028e3660046117d6565b610b2a565b6101db6102a1366004611556565b610b66565b6101db6102b4366004611556565b610ca5565b6101e17f000000000000000000000000000000000000000000000000000000000000000081565b600c5460ff1661021c565b6101db6102f9366004611892565b505050505050565b600454610314906001600160a01b031681565b6040516001600160a01b0390911681526020016101eb565b6101db61033a366004611556565b610cdb565b6008546001600160a01b0316610314565b600254610314906001600160a01b031681565b6101db610371366004611716565b610d11565b6101e160015481565b6005546101e1565b6101e160005481565b6007546101e1565b600354610314906001600160a01b031681565b6101db6103b9366004611923565b610ec0565b6101db6103cc366004611556565b610f35565b6101e16103df3660046115d8565b610f6b565b6008546001600160a01b031633146104165760405163351c880f60e01b81523360048201526024015b60405180910390fd5b61041f81610f76565b50565b6060600a80548060200260200160405190810160405280929190818152602001828054801561047a57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831161045c575b5050505050905090565b6001600160a01b0381166000908152600b602052604081205415155b92915050565b60095415806104b6575060095481105b156104d457604051630833b4e360e41b815260040160405180910390fd5b6000600460009054906101000a90046001600160a01b03166001600160a01b031663c5f2892f6040518163ffffffff1660e01b815260040160206040518083038186803b15801561052457600080fd5b505afa158015610538573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061055c91906119c1565b905080881461057e576040516302d654b160e41b815260040160405180910390fd5b600354604051636608b11b60e01b8152600481018990526001600160a01b0390911690636608b11b9060240160206040518083038186803b1580156105c257600080fd5b505afa1580156105d6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105fa91906119da565b6106175760405163fa7f287160e01b815260040160405180910390fd5b60035460405163473e043360e01b8152600481018990526000916001600160a01b03169063473e04339060240160206040518083038186803b15801561065c57600080fd5b505afa158015610670573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061069491906119c1565b6006549091506106a48243611a12565b10156106c357604051633ec3745360e11b815260040160405180910390fd5b8915806106d15750898b4014155b156106ef576040516328aada8b60e21b815260040160405180910390fd5b600354604051630519fbbf60e01b8152600481018a90526000916001600160a01b031690630519fbbf9060240160206040518083038186803b15801561073457600080fd5b505afa158015610748573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061076c91906119c1565b905080881461078e57604051632e8f7e7360e11b815260040160405180910390fd5b6107ee8a8d8d8c8c8a8a808060200260200160405190810160405280939291908181526020016000905b828210156107e4576107d560408302860136819003810190611a29565b815260200190600101906107b8565b5050505050610fb2565b60025460055460405163aa0b7db760e01b81526001600160a01b039092169163aa0b7db791610825918d908c908c90600401611a45565b600060405180830381600087803b15801561083f57600080fd5b505af1158015610853573d6000803e3d6000fd5b50505050505050505050505050505050565b6008546001600160a01b031633146108925760405163351c880f60e01b815233600482015260240161040d565b61089b826110e1565b6108a4816111f5565b5050565b6008546001600160a01b031633146108d55760405163351c880f60e01b815233600482015260240161040d565b61041f81611233565b6003546040516329cd0ca760e21b8152600481018390526000916001600160a01b03169063a734329c9060240160206040518083038186803b15801561092357600080fd5b505afa158015610937573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061095b91906119da565b61096757506000919050565b600354604051636608b11b60e01b8152600481018490526000916001600160a01b031690636608b11b9060240160206040518083038186803b1580156109ac57600080fd5b505afa1580156109c0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109e491906119da565b60035460405163473e043360e01b8152600481018690529192506000916001600160a01b039091169063473e04339060240160206040518083038186803b158015610a2e57600080fd5b505afa158015610a42573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a6691906119c1565b90506000600260009054906101000a90046001600160a01b03166001600160a01b031663e78a58756040518163ffffffff1660e01b815260040160206040518083038186803b158015610ab857600080fd5b505afa158015610acc573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610af091906119da565b9050828015610b0157506000600954115b8015610b185750600654610b158343611a12565b10155b8015610b215750805b95945050505050565b60405133907feb225a736fbfee3f85ccb72bdf84ff0396ab358b7970e2cc351ab3e3fd92358d90600090a25050600c805460ff19166001179055565b6008546001600160a01b03163314610b935760405163351c880f60e01b815233600482015260240161040d565b60035460405163e24ce9f160e01b8152600481018390526001600160a01b039091169063e24ce9f19060240160206040518083038186803b158015610bd757600080fd5b505afa158015610beb573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c0f91906119da565b1561041f57600354604051633618716160e21b8152600481018390526001600160a01b039091169063d861c58490602401600060405180830381600087803b158015610c5a57600080fd5b505af1158015610c6e573d6000803e3d6000fd5b505060405162ffffff841692507fb861fabb6dfce807f39e6f400693b8a826dcd89a4ce4ff8e955f6c4ddec398a39150600090a250565b6008546001600160a01b03163314610cd25760405163351c880f60e01b815233600482015260240161040d565b61041f816111f5565b6008546001600160a01b03163314610d085760405163351c880f60e01b815233600482015260240161040d565b61041f816112c4565b6008546001600160a01b03163314610d3e5760405163351c880f60e01b815233600482015260240161040d565b6001600160a01b0382166000908152600b602052604090205480610d80576040516302333ca160e51b81526001600160a01b038416600482015260240161040d565b600a5480821115610d9357610d93611a82565b808214610e29576000600a610da9600184611a12565b81548110610db957610db9611a98565b6000918252602090912001546001600160a01b0316905080600a610dde600186611a12565b81548110610dee57610dee611a98565b600091825260208083209190910180546001600160a01b0319166001600160a01b03948516179055929091168152600b909152604090208290555b6001600160a01b0384166000908152600b6020526040812055600a805480610e5357610e53611aae565b600082815260209020810160001990810180546001600160a01b0319169055019055610e7e836111f5565b6040516001600160a01b03851681527fb8107d0c6b40be480ce3172ee66ba6d64b71f6b1685a851340036e6e2e3e3c529060200160405180910390a150505050565b6008546001600160a01b03163314610eed5760405163351c880f60e01b815233600482015260240161040d565b60005b8251811015610f2b57610f1b838281518110610f0e57610f0e611a98565b60200260200101516110e1565b610f2481611ac4565b9050610ef0565b506108a4816111f5565b6008546001600160a01b03163314610f625760405163351c880f60e01b815233600482015260240161040d565b61041f81611350565b60006104a0826113d3565b60058190556040518181527f4d72502b63cfe737b98b225a53708fe347cf8274baed31e0c4e4941b758da992906020015b60405180910390a150565b600080546040805160208101929092528101879052606081018690526080810188905260a0810185905260c0810184905260e0016040516020818303038152906040528051906020012090506000805b83518110156110d65760006110528486848151811061102357611023611a98565b60200260200101516000015187858151811061104157611041611a98565b6020026020010151602001516113f8565b9050611075816001600160a01b03166000908152600b6020526040902054151590565b61109257604051638baa579f60e01b815260040160405180910390fd5b826001600160a01b0316816001600160a01b0316116110c4576040516301eba55160e01b815260040160405180910390fd5b91506110cf81611ac4565b9050611002565b505050505050505050565b6001600160a01b0381166111275760405163eac0d38960e01b815260206004820152600c60248201526b2fb732bba3bab0b93234b0b760a11b604482015260640161040d565b6001600160a01b0381166000908152600b60205260409020541561116957604051639f2277f360e01b81526001600160a01b038216600482015260240161040d565b600a80546001810182557fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a80180546001600160a01b0319166001600160a01b03841690811790915590546000828152600b602090815260409182902092909255519182527f038596bb31e2e7d3d9f184d4c98b310103f6d7f5830e5eec32bffe6f1728f9699101610fa7565b806009541461041f5760098190556040518181527f70d7432f2ec830b36e5b8c45176a8079968714429c4be85665c06ec1b8fde4bb90602001610fa7565b6001600160a01b0381166112765760405163eac0d38960e01b81526020600482015260096024820152682fb732bba7bbb732b960b91b604482015260640161040d565b600880546001600160a01b0319166001600160a01b0383169081179091556040519081527fa2ea9883a321a3e97b8266c2b078bfeec6d50c711ed71f874a90d500ae2eaf3690602001610fa7565b8061131257604051631fd43b6f60e21b815260206004820152601760248201527f6d696e4465706f736974426c6f636b44697374616e6365000000000000000000604482015260640161040d565b600654811461041f5760068190556040518181527fdb69cbc4aa6648b506b7854c26807bfd811c27feaf97ac8847e3a66356cace1490602001610fa7565b8061139e57604051631fd43b6f60e21b815260206004820152601f60248201527f7061757365496e74656e7456616c6964697479506572696f64426c6f636b7300604482015260640161040d565b60078190556040518181527f8120886d27fee35672e5d5a482d6c858105aebb26caf12178b8c0034fa88c2ba90602001610fa7565b6001600160a01b0381166000908152600b60205260408120546104a090600190611adf565b60006001600160ff1b03821660ff83901c601b0161141886828785611422565b9695505050505050565b60007f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a082111561149f5760405162461bcd60e51b815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202773272076616c604482015261756560f01b606482015260840161040d565b6040805160008082526020820180845288905260ff871692820192909252606081018590526080810184905260019060a0016020604051602081039080840390855afa1580156114f3573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116610b215760405162461bcd60e51b815260206004820152601860248201527f45434453413a20696e76616c6964207369676e61747572650000000000000000604482015260640161040d565b60006020828403121561156857600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b818110156115b05783516001600160a01b03168352928401929184019160010161158b565b50909695505050505050565b80356001600160a01b03811681146115d357600080fd5b919050565b6000602082840312156115ea57600080fd5b6115f3826115bc565b9392505050565b60008083601f84011261160c57600080fd5b50813567ffffffffffffffff81111561162457600080fd5b6020830191508360208260061b850101111561163f57600080fd5b9250929050565b600080600080600080600080600060e08a8c03121561166457600080fd5b8935985060208a0135975060408a0135965060608a0135955060808a0135945060a08a013567ffffffffffffffff8082111561169f57600080fd5b818c0191508c601f8301126116b357600080fd5b8135818111156116c257600080fd5b8d60208285010111156116d457600080fd5b6020830196508095505060c08c01359150808211156116f257600080fd5b506116ff8c828d016115fa565b915080935050809150509295985092959850929598565b6000806040838503121561172957600080fd5b611732836115bc565b946020939093013593505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561177f5761177f611740565b604052919050565b60006040828403121561179957600080fd5b6040516040810181811067ffffffffffffffff821117156117bc576117bc611740565b604052823581526020928301359281019290925250919050565b600080606083850312156117e957600080fd5b823591506117fa8460208501611787565b90509250929050565b600067ffffffffffffffff82111561181d5761181d611740565b5060051b60200190565b600082601f83011261183857600080fd5b8135602061184d61184883611803565b611756565b82815260059290921b8401810191818101908684111561186c57600080fd5b8286015b848110156118875780358352918301918301611870565b509695505050505050565b60008060008060008060e087890312156118ab57600080fd5b863595506020870135945060408701359350606087013567ffffffffffffffff808211156118d857600080fd5b6118e48a838b01611827565b945060808901359150808211156118fa57600080fd5b5061190789828a01611827565b9250506119178860a08901611787565b90509295509295509295565b6000806040838503121561193657600080fd5b823567ffffffffffffffff81111561194d57600080fd5b8301601f8101851361195e57600080fd5b8035602061196e61184883611803565b82815260059290921b8301810191818101908884111561198d57600080fd5b938201935b838510156119b2576119a3856115bc565b82529382019390820190611992565b98969091013596505050505050565b6000602082840312156119d357600080fd5b5051919050565b6000602082840312156119ec57600080fd5b815180151581146115f357600080fd5b634e487b7160e01b600052601160045260246000fd5b600082821015611a2457611a246119fc565b500390565b600060408284031215611a3b57600080fd5b6115f38383611787565b84815283602082015260606040820152816060820152818360808301376000818301608090810191909152601f909201601f191601019392505050565b634e487b7160e01b600052600160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052603160045260246000fd5b6000600019821415611ad857611ad86119fc565b5060010190565b60008083128015600160ff1b850184121615611afd57611afd6119fc565b6001600160ff1b0384018313811615611b1857611b186119fc565b5050039056fea264697066735822122083ea54eba20d8789ae2fe00fa67b7243e81422b157b16a216c19f585b21b2eb764736f6c63430008090033'
LIDO_LOCATOR_BYTECODE = '0x6102406040523480156200001257600080fd5b5060405162000a3238038062000a32833981016040819052620000359162000254565b80516200004290620001d1565b6001600160a01b031660805260208101516200005e90620001d1565b6001600160a01b031660a05260408101516200007a90620001d1565b6001600160a01b031660c05260608101516200009690620001d1565b6001600160a01b031660e0526080810151620000b290620001d1565b6001600160a01b03166101005260a0810151620000cf90620001d1565b6001600160a01b03166101205260c0810151620000ec90620001d1565b6001600160a01b03166101405260e08101516200010990620001d1565b6001600160a01b0316610160526101008101516200012790620001d1565b6001600160a01b0316610180526101208101516200014590620001d1565b6001600160a01b03166101a0526101408101516200016390620001d1565b6001600160a01b03166101c0526101608101516200018190620001d1565b6001600160a01b03166101e0526101808101516200019f90620001d1565b6001600160a01b0316610200526101a0810151620001bd90620001d1565b6001600160a01b0316610220525062000383565b60006001600160a01b038216620001fb5760405163d92e233d60e01b815260040160405180910390fd5b5090565b6040516101c081016001600160401b03811182821017156200023157634e487b7160e01b600052604160045260246000fd5b60405290565b80516001600160a01b03811681146200024f57600080fd5b919050565b60006101c082840312156200026857600080fd5b62000272620001ff565b6200027d8362000237565b81526200028d6020840162000237565b6020820152620002a06040840162000237565b6040820152620002b36060840162000237565b6060820152620002c66080840162000237565b6080820152620002d960a0840162000237565b60a0820152620002ec60c0840162000237565b60c0820152620002ff60e0840162000237565b60e08201526101006200031481850162000237565b908201526101206200032884820162000237565b908201526101406200033c84820162000237565b908201526101606200035084820162000237565b908201526101806200036484820162000237565b908201526101a06200037884820162000237565b908201529392505050565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e05161020051610220516105ac6200048660003960006103f501526000818161026c015281816103980152610491015260008181610244015281816102a101526103700152600061010a01526000818161021c015261046a0152600081816101f2015261052d01526000818161017501526103480152600081816103c001526104df0152600081816101ca0152818161031e01526105540152600061014e015260006104b80152600081816101a5015281816102f601526105060152600061041c0152600081816102d1015261044301526105ac6000f3fe608060405234801561001057600080fd5b50600436106101005760003560e01c80635a2031f911610097578063d680a87611610066578063d680a876146104da578063e441d25f14610501578063ef6c064c14610528578063f5e6d50f1461054f57600080fd5b80635a2031f91461043e57806361d027b31461046557806369d421481461048c578063996107aa146104b357600080fd5b806337d5fe99116100d357806337d5fe991461029c5780633cbf357e146102c35780633fe7d554146103f0578063472c17761461041757600080fd5b806312f8d4b91461010557806323509a2d1461014957806327810b6e1461017057806335f4022e14610197575b600080fd5b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b604080516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000811682527f0000000000000000000000000000000000000000000000000000000000000000811660208301527f00000000000000000000000000000000000000000000000000000000000000008116928201929092527f0000000000000000000000000000000000000000000000000000000000000000821660608201527f0000000000000000000000000000000000000000000000000000000000000000821660808201527f00000000000000000000000000000000000000000000000000000000000000009190911660a082015260c001610140565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b604080516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000811682527f0000000000000000000000000000000000000000000000000000000000000000811660208301527f00000000000000000000000000000000000000000000000000000000000000008116928201929092527f0000000000000000000000000000000000000000000000000000000000000000821660608201527f0000000000000000000000000000000000000000000000000000000000000000821660808201527f0000000000000000000000000000000000000000000000000000000000000000821660a08201527f00000000000000000000000000000000000000000000000000000000000000009190911660c082015260e001610140565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f00000000000000000000000000000000000000000000000000000000000000008156fea2646970667358221220f56a7e9b46d8e22c7fbd5bfb01e236cd03fd8640f62ca4bf7a383de86337258d64736f6c63430008090033'


def upgrade_staking_router_to_v2(web3_lido_integration: Web3):
    contract = web3_lido_integration.eth.contract(
        abi=DepositSecurityModuleContractV2.load_abi(DepositSecurityModuleContractV2.abi_path),
        bytecode=DSM_V2_BYTECODE,
    )

    tx_hash = contract.constructor().transact()
    tx_receipt = web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)
    dsm_address = tx_receipt.contractAddress

    locator_contract = web3_lido_integration.eth.contract(
        abi=LidoLocatorContract.load_abi(LidoLocatorContract.abi_path),
        bytecode=LIDO_LOCATOR_BYTECODE,
    )

    tx_hash = locator_contract.constructor([
        web3_lido_integration.lido.lido_locator.functions.accountingOracle().call(),
        dsm_address,
        web3_lido_integration.lido.lido_locator.functions.elRewardsVault().call(),
        web3_lido_integration.lido.lido_locator.functions.legacyOracle().call(),
        web3_lido_integration.lido.lido_locator.functions.lido().call(),
        web3_lido_integration.lido.lido_locator.functions.oracleReportSanityChecker().call(),
        web3_lido_integration.lido.lido_locator.functions.postTokenRebaseReceiver().call(),
        web3_lido_integration.lido.lido_locator.functions.burner().call(),
        web3_lido_integration.lido.lido_locator.functions.stakingRouter().call(),
        web3_lido_integration.lido.lido_locator.functions.treasury().call(),
        web3_lido_integration.lido.lido_locator.functions.validatorsExitBusOracle().call(),
        web3_lido_integration.lido.lido_locator.functions.withdrawalQueue().call(),
        web3_lido_integration.lido.lido_locator.functions.withdrawalVault().call(),
        web3_lido_integration.lido.lido_locator.functions.oracleDaemonConfig().call(),
    ]).transact()
    tx_receipt = web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)
    new_locator = tx_receipt.contractAddress

    proxy = web3_lido_integration.eth.contract(
        address=variables.LIDO_LOCATOR,
        abi=web3_lido_integration.lido.lido_locator.load_abi('./interfaces/Proxy.json'),
    )

    admin = proxy.functions.proxy__getAdmin().call()

    web3_lido_integration.provider.make_request('anvil_setBalance', [admin, 10 ** 18])

    tx_hash = proxy.functions.proxy__upgradeTo(new_locator).transact({'from': admin})
    web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)

    assert web3_lido_integration.lido.has_contract_address_changed()
