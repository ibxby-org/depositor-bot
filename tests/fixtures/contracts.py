from typing import cast

import pytest

import variables
from blockchain.contracts.deposit_security_module import DepositSecurityModuleContract, DepositSecurityModuleContractV2
from blockchain.contracts.lido import LidoContract
from blockchain.contracts.lido_locator import LidoLocatorContract
from blockchain.contracts.deposit import DepositContract
from blockchain.contracts.staking_router import StakingRouterContract
from blockchain.typings import Web3


@pytest.fixture
def lido_locator(web3_provider_integration):
    yield cast(LidoLocatorContract, web3_provider_integration.eth.contract(
        address=variables.LIDO_LOCATOR,
        ContractFactoryClass=LidoLocatorContract,
    ))


@pytest.fixture
def deposit_contract(web3_provider_integration):
    yield cast(DepositContract, web3_provider_integration.eth.contract(
        address=variables.DEPOSIT_CONTRACT,
        ContractFactoryClass=DepositContract,
    ))


@pytest.fixture
def lido_contract(web3_provider_integration, lido_locator):
    yield cast(LidoContract, web3_provider_integration.eth.contract(
        address=lido_locator.lido(),
        ContractFactoryClass=LidoContract,
    ))


@pytest.fixture
def deposit_security_module(web3_provider_integration, lido_locator):
    yield cast(DepositSecurityModuleContract, web3_provider_integration.eth.contract(
        address=lido_locator.deposit_security_module(),
        ContractFactoryClass=DepositSecurityModuleContract,
    ))


@pytest.fixture
def deposit_security_module_v2(web3_lido_integration, lido_locator):
    upgrade_staking_router_to_v2(web3_lido_integration)
    yield cast(DepositSecurityModuleContractV2, web3_lido_integration.eth.contract(
        address=lido_locator.deposit_security_module(),
        ContractFactoryClass=DepositSecurityModuleContractV2,
    ))


@pytest.fixture
def staking_router(web3_provider_integration, lido_locator):
    yield cast(StakingRouterContract, web3_provider_integration.eth.contract(
        address=lido_locator.staking_router(),
        ContractFactoryClass=StakingRouterContract,
    ))


DSM_V2_BYTECODE = '0x60a06040527f2dd9727393562ed11c29080a884630e2d3a7078e71b313e713a8a1ef68948f6a608052600360055560e160068190556007819055600855600d805460ff1916905534801561005257600080fd5b50608051611b6861006e60003960006102c90152611b686000f3fe608060405234801561001057600080fd5b50600436106101ce5760003560e01c80636058fa9111610104578063b7b7a408116100a2578063c8f712d511610071578063c8f712d5146103b6578063eccd085f146103c9578063f47610e6146103dc578063ffa1ad74146103ef57600080fd5b8063b7b7a4081461038a578063c6dda2c314610392578063c7062e981461039b578063c8a5f8e6146103a357600080fd5b8063893d20e8116100de578063893d20e81461034a5780638b21f1701461035b5780638d71a6f41461036e578063a50833d61461038157600080fd5b80636058fa91146102f65780636b96736b1461030c5780637e9233121461033757600080fd5b8063251e3a21116101715780633bab964e1161014b5780633bab964e1461029e5780633e6f6d68146102b15780634d72ba86146102c457806351ac3c39146102eb57600080fd5b8063251e3a211461027057806339443b8e146102785780633ab54bc31461028b57600080fd5b80630c68ba21116101ad5780630c68ba21146102145780630df9a86d14610237578063111e53131461024a57806313af40351461025d57600080fd5b8062fed902146101d3578063062b662e146101e85780630665f04b146101ff575b600080fd5b6101e66101e136600461156a565b6103f8565b005b600a545b6040519081526020015b60405180910390f35b610207610436565b6040516101f69190611583565b6102276102223660046115ec565b610498565b60405190151581526020016101f6565b6101e661024536600461165a565b6104ba565b6101e661025836600461172a565b610879565b6101e661026b3660046115ec565b6108bc565b6007546101ec565b61022761028636600461156a565b6108f2565b6101e66102993660046117ea565b610b3e565b6101e66102ac36600461156a565b610b7a565b6101e66102bf36600461156a565b610cb9565b6101ec7f000000000000000000000000000000000000000000000000000000000000000081565b600d5460ff16610227565b6101e66103043660046118a6565b505050505050565b60045461031f906001600160a01b031681565b6040516001600160a01b0390911681526020016101f6565b6101e661034536600461156a565b610cef565b6009546001600160a01b031661031f565b60025461031f906001600160a01b031681565b6101e661037c36600461172a565b610d25565b6101ec60015481565b6006546101ec565b6101ec60005481565b6008546101ec565b60035461031f906001600160a01b031681565b6101e66103c4366004611937565b610ed4565b6101e66103d736600461156a565b610f49565b6101ec6103ea3660046115ec565b610f7f565b6101ec60055481565b6009546001600160a01b0316331461042a5760405163351c880f60e01b81523360048201526024015b60405180910390fd5b61043381610f8a565b50565b6060600b80548060200260200160405190810160405280929190818152602001828054801561048e57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610470575b5050505050905090565b6001600160a01b0381166000908152600c602052604081205415155b92915050565b600a5415806104ca5750600a5481105b156104e857604051630833b4e360e41b815260040160405180910390fd5b6000600460009054906101000a90046001600160a01b03166001600160a01b031663c5f2892f6040518163ffffffff1660e01b815260040160206040518083038186803b15801561053857600080fd5b505afa15801561054c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061057091906119d5565b9050808814610592576040516302d654b160e41b815260040160405180910390fd5b600354604051636608b11b60e01b8152600481018990526001600160a01b0390911690636608b11b9060240160206040518083038186803b1580156105d657600080fd5b505afa1580156105ea573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061060e91906119ee565b61062b5760405163fa7f287160e01b815260040160405180910390fd5b60035460405163473e043360e01b8152600481018990526000916001600160a01b03169063473e04339060240160206040518083038186803b15801561067057600080fd5b505afa158015610684573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106a891906119d5565b6007549091506106b88243611a26565b10156106d757604051633ec3745360e11b815260040160405180910390fd5b8915806106e55750898b4014155b15610703576040516328aada8b60e21b815260040160405180910390fd5b600354604051630519fbbf60e01b8152600481018a90526000916001600160a01b031690630519fbbf9060240160206040518083038186803b15801561074857600080fd5b505afa15801561075c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061078091906119d5565b90508088146107a257604051632e8f7e7360e11b815260040160405180910390fd5b6108028a8d8d8c8c8a8a808060200260200160405190810160405280939291908181526020016000905b828210156107f8576107e960408302860136819003810190611a3d565b815260200190600101906107cc565b5050505050610fc6565b60025460065460405163aa0b7db760e01b81526001600160a01b039092169163aa0b7db791610839918d908c908c90600401611a59565b600060405180830381600087803b15801561085357600080fd5b505af1158015610867573d6000803e3d6000fd5b50505050505050505050505050505050565b6009546001600160a01b031633146108a65760405163351c880f60e01b8152336004820152602401610421565b6108af826110f5565b6108b881611209565b5050565b6009546001600160a01b031633146108e95760405163351c880f60e01b8152336004820152602401610421565b61043381611247565b6003546040516329cd0ca760e21b8152600481018390526000916001600160a01b03169063a734329c9060240160206040518083038186803b15801561093757600080fd5b505afa15801561094b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061096f91906119ee565b61097b57506000919050565b600354604051636608b11b60e01b8152600481018490526000916001600160a01b031690636608b11b9060240160206040518083038186803b1580156109c057600080fd5b505afa1580156109d4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109f891906119ee565b60035460405163473e043360e01b8152600481018690529192506000916001600160a01b039091169063473e04339060240160206040518083038186803b158015610a4257600080fd5b505afa158015610a56573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a7a91906119d5565b90506000600260009054906101000a90046001600160a01b03166001600160a01b031663e78a58756040518163ffffffff1660e01b815260040160206040518083038186803b158015610acc57600080fd5b505afa158015610ae0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b0491906119ee565b9050828015610b1557506000600a54115b8015610b2c5750600754610b298343611a26565b10155b8015610b355750805b95945050505050565b60405133907feb225a736fbfee3f85ccb72bdf84ff0396ab358b7970e2cc351ab3e3fd92358d90600090a25050600d805460ff19166001179055565b6009546001600160a01b03163314610ba75760405163351c880f60e01b8152336004820152602401610421565b60035460405163e24ce9f160e01b8152600481018390526001600160a01b039091169063e24ce9f19060240160206040518083038186803b158015610beb57600080fd5b505afa158015610bff573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c2391906119ee565b1561043357600354604051633618716160e21b8152600481018390526001600160a01b039091169063d861c58490602401600060405180830381600087803b158015610c6e57600080fd5b505af1158015610c82573d6000803e3d6000fd5b505060405162ffffff841692507fb861fabb6dfce807f39e6f400693b8a826dcd89a4ce4ff8e955f6c4ddec398a39150600090a250565b6009546001600160a01b03163314610ce65760405163351c880f60e01b8152336004820152602401610421565b61043381611209565b6009546001600160a01b03163314610d1c5760405163351c880f60e01b8152336004820152602401610421565b610433816112d8565b6009546001600160a01b03163314610d525760405163351c880f60e01b8152336004820152602401610421565b6001600160a01b0382166000908152600c602052604090205480610d94576040516302333ca160e51b81526001600160a01b0384166004820152602401610421565b600b5480821115610da757610da7611a96565b808214610e3d576000600b610dbd600184611a26565b81548110610dcd57610dcd611aac565b6000918252602090912001546001600160a01b0316905080600b610df2600186611a26565b81548110610e0257610e02611aac565b600091825260208083209190910180546001600160a01b0319166001600160a01b03948516179055929091168152600c909152604090208290555b6001600160a01b0384166000908152600c6020526040812055600b805480610e6757610e67611ac2565b600082815260209020810160001990810180546001600160a01b0319169055019055610e9283611209565b6040516001600160a01b03851681527fb8107d0c6b40be480ce3172ee66ba6d64b71f6b1685a851340036e6e2e3e3c529060200160405180910390a150505050565b6009546001600160a01b03163314610f015760405163351c880f60e01b8152336004820152602401610421565b60005b8251811015610f3f57610f2f838281518110610f2257610f22611aac565b60200260200101516110f5565b610f3881611ad8565b9050610f04565b506108b881611209565b6009546001600160a01b03163314610f765760405163351c880f60e01b8152336004820152602401610421565b61043381611364565b60006104b4826113e7565b60068190556040518181527f4d72502b63cfe737b98b225a53708fe347cf8274baed31e0c4e4941b758da992906020015b60405180910390a150565b600080546040805160208101929092528101879052606081018690526080810188905260a0810185905260c0810184905260e0016040516020818303038152906040528051906020012090506000805b83518110156110ea5760006110668486848151811061103757611037611aac565b60200260200101516000015187858151811061105557611055611aac565b60200260200101516020015161140c565b9050611089816001600160a01b03166000908152600c6020526040902054151590565b6110a657604051638baa579f60e01b815260040160405180910390fd5b826001600160a01b0316816001600160a01b0316116110d8576040516301eba55160e01b815260040160405180910390fd5b91506110e381611ad8565b9050611016565b505050505050505050565b6001600160a01b03811661113b5760405163eac0d38960e01b815260206004820152600c60248201526b2fb732bba3bab0b93234b0b760a11b6044820152606401610421565b6001600160a01b0381166000908152600c60205260409020541561117d57604051639f2277f360e01b81526001600160a01b0382166004820152602401610421565b600b80546001810182557f0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db90180546001600160a01b0319166001600160a01b03841690811790915590546000828152600c602090815260409182902092909255519182527f038596bb31e2e7d3d9f184d4c98b310103f6d7f5830e5eec32bffe6f1728f9699101610fbb565b80600a541461043357600a8190556040518181527f70d7432f2ec830b36e5b8c45176a8079968714429c4be85665c06ec1b8fde4bb90602001610fbb565b6001600160a01b03811661128a5760405163eac0d38960e01b81526020600482015260096024820152682fb732bba7bbb732b960b91b6044820152606401610421565b600980546001600160a01b0319166001600160a01b0383169081179091556040519081527fa2ea9883a321a3e97b8266c2b078bfeec6d50c711ed71f874a90d500ae2eaf3690602001610fbb565b8061132657604051631fd43b6f60e21b815260206004820152601760248201527f6d696e4465706f736974426c6f636b44697374616e63650000000000000000006044820152606401610421565b60075481146104335760078190556040518181527fdb69cbc4aa6648b506b7854c26807bfd811c27feaf97ac8847e3a66356cace1490602001610fbb565b806113b257604051631fd43b6f60e21b815260206004820152601f60248201527f7061757365496e74656e7456616c6964697479506572696f64426c6f636b73006044820152606401610421565b60088190556040518181527f8120886d27fee35672e5d5a482d6c858105aebb26caf12178b8c0034fa88c2ba90602001610fbb565b6001600160a01b0381166000908152600c60205260408120546104b490600190611af3565b60006001600160ff1b03821660ff83901c601b0161142c86828785611436565b9695505050505050565b60007f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a08211156114b35760405162461bcd60e51b815260206004820152602260248201527f45434453413a20696e76616c6964207369676e6174757265202773272076616c604482015261756560f01b6064820152608401610421565b6040805160008082526020820180845288905260ff871692820192909252606081018590526080810184905260019060a0016020604051602081039080840390855afa158015611507573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116610b355760405162461bcd60e51b815260206004820152601860248201527f45434453413a20696e76616c6964207369676e617475726500000000000000006044820152606401610421565b60006020828403121561157c57600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b818110156115c45783516001600160a01b03168352928401929184019160010161159f565b50909695505050505050565b80356001600160a01b03811681146115e757600080fd5b919050565b6000602082840312156115fe57600080fd5b611607826115d0565b9392505050565b60008083601f84011261162057600080fd5b50813567ffffffffffffffff81111561163857600080fd5b6020830191508360208260061b850101111561165357600080fd5b9250929050565b600080600080600080600080600060e08a8c03121561167857600080fd5b8935985060208a0135975060408a0135965060608a0135955060808a0135945060a08a013567ffffffffffffffff808211156116b357600080fd5b818c0191508c601f8301126116c757600080fd5b8135818111156116d657600080fd5b8d60208285010111156116e857600080fd5b6020830196508095505060c08c013591508082111561170657600080fd5b506117138c828d0161160e565b915080935050809150509295985092959850929598565b6000806040838503121561173d57600080fd5b611746836115d0565b946020939093013593505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff8111828210171561179357611793611754565b604052919050565b6000604082840312156117ad57600080fd5b6040516040810181811067ffffffffffffffff821117156117d0576117d0611754565b604052823581526020928301359281019290925250919050565b600080606083850312156117fd57600080fd5b8235915061180e846020850161179b565b90509250929050565b600067ffffffffffffffff82111561183157611831611754565b5060051b60200190565b600082601f83011261184c57600080fd5b8135602061186161185c83611817565b61176a565b82815260059290921b8401810191818101908684111561188057600080fd5b8286015b8481101561189b5780358352918301918301611884565b509695505050505050565b60008060008060008060e087890312156118bf57600080fd5b863595506020870135945060408701359350606087013567ffffffffffffffff808211156118ec57600080fd5b6118f88a838b0161183b565b9450608089013591508082111561190e57600080fd5b5061191b89828a0161183b565b92505061192b8860a0890161179b565b90509295509295509295565b6000806040838503121561194a57600080fd5b823567ffffffffffffffff81111561196157600080fd5b8301601f8101851361197257600080fd5b8035602061198261185c83611817565b82815260059290921b830181019181810190888411156119a157600080fd5b938201935b838510156119c6576119b7856115d0565b825293820193908201906119a6565b98969091013596505050505050565b6000602082840312156119e757600080fd5b5051919050565b600060208284031215611a0057600080fd5b8151801515811461160757600080fd5b634e487b7160e01b600052601160045260246000fd5b600082821015611a3857611a38611a10565b500390565b600060408284031215611a4f57600080fd5b611607838361179b565b84815283602082015260606040820152816060820152818360808301376000818301608090810191909152601f909201601f191601019392505050565b634e487b7160e01b600052600160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052603160045260246000fd5b6000600019821415611aec57611aec611a10565b5060010190565b60008083128015600160ff1b850184121615611b1157611b11611a10565b6001600160ff1b0384018313811615611b2c57611b2c611a10565b5050039056fea2646970667358221220b507701f59cb219d85c7e7c1e9d3175649878685ff47efc0ab014be949015c7364736f6c63430008090033'
LIDO_LOCATOR_BYTECODE = '0x6102406040523480156200001257600080fd5b5060405162000a3238038062000a32833981016040819052620000359162000254565b80516200004290620001d1565b6001600160a01b031660805260208101516200005e90620001d1565b6001600160a01b031660a05260408101516200007a90620001d1565b6001600160a01b031660c05260608101516200009690620001d1565b6001600160a01b031660e0526080810151620000b290620001d1565b6001600160a01b03166101005260a0810151620000cf90620001d1565b6001600160a01b03166101205260c0810151620000ec90620001d1565b6001600160a01b03166101405260e08101516200010990620001d1565b6001600160a01b0316610160526101008101516200012790620001d1565b6001600160a01b0316610180526101208101516200014590620001d1565b6001600160a01b03166101a0526101408101516200016390620001d1565b6001600160a01b03166101c0526101608101516200018190620001d1565b6001600160a01b03166101e0526101808101516200019f90620001d1565b6001600160a01b0316610200526101a0810151620001bd90620001d1565b6001600160a01b0316610220525062000383565b60006001600160a01b038216620001fb5760405163d92e233d60e01b815260040160405180910390fd5b5090565b6040516101c081016001600160401b03811182821017156200023157634e487b7160e01b600052604160045260246000fd5b60405290565b80516001600160a01b03811681146200024f57600080fd5b919050565b60006101c082840312156200026857600080fd5b62000272620001ff565b6200027d8362000237565b81526200028d6020840162000237565b6020820152620002a06040840162000237565b6040820152620002b36060840162000237565b6060820152620002c66080840162000237565b6080820152620002d960a0840162000237565b60a0820152620002ec60c0840162000237565b60c0820152620002ff60e0840162000237565b60e08201526101006200031481850162000237565b908201526101206200032884820162000237565b908201526101406200033c84820162000237565b908201526101606200035084820162000237565b908201526101806200036484820162000237565b908201526101a06200037884820162000237565b908201529392505050565b60805160a05160c05160e05161010051610120516101405161016051610180516101a0516101c0516101e05161020051610220516105ac6200048660003960006103f501526000818161026c015281816103980152610491015260008181610244015281816102a101526103700152600061010a01526000818161021c015261046a0152600081816101f2015261052d01526000818161017501526103480152600081816103c001526104df0152600081816101ca0152818161031e01526105540152600061014e015260006104b80152600081816101a5015281816102f601526105060152600061041c0152600081816102d1015261044301526105ac6000f3fe608060405234801561001057600080fd5b50600436106101005760003560e01c80635a2031f911610097578063d680a87611610066578063d680a876146104da578063e441d25f14610501578063ef6c064c14610528578063f5e6d50f1461054f57600080fd5b80635a2031f91461043e57806361d027b31461046557806369d421481461048c578063996107aa146104b357600080fd5b806337d5fe99116100d357806337d5fe991461029c5780633cbf357e146102c35780633fe7d554146103f0578063472c17761461041757600080fd5b806312f8d4b91461010557806323509a2d1461014957806327810b6e1461017057806335f4022e14610197575b600080fd5b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b604080516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000811682527f0000000000000000000000000000000000000000000000000000000000000000811660208301527f00000000000000000000000000000000000000000000000000000000000000008116928201929092527f0000000000000000000000000000000000000000000000000000000000000000821660608201527f0000000000000000000000000000000000000000000000000000000000000000821660808201527f00000000000000000000000000000000000000000000000000000000000000009190911660a082015260c001610140565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b604080516001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000811682527f0000000000000000000000000000000000000000000000000000000000000000811660208301527f00000000000000000000000000000000000000000000000000000000000000008116928201929092527f0000000000000000000000000000000000000000000000000000000000000000821660608201527f0000000000000000000000000000000000000000000000000000000000000000821660808201527f0000000000000000000000000000000000000000000000000000000000000000821660a08201527f00000000000000000000000000000000000000000000000000000000000000009190911660c082015260e001610140565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f000000000000000000000000000000000000000000000000000000000000000081565b61012c7f00000000000000000000000000000000000000000000000000000000000000008156fea2646970667358221220f56a7e9b46d8e22c7fbd5bfb01e236cd03fd8640f62ca4bf7a383de86337258d64736f6c63430008090033'


def upgrade_staking_router_to_v2(web3_lido_integration: Web3):
    contract = web3_lido_integration.eth.contract(
        abi=DepositSecurityModuleContractV2.load_abi(DepositSecurityModuleContractV2.abi_path),
        bytecode=DSM_V2_BYTECODE,
    )

    tx_hash = contract.constructor().transact()
    tx_receipt = web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)
    dsm_address = tx_receipt.contractAddress

    locator_contract = web3_lido_integration.eth.contract(
        abi=LidoLocatorContract.load_abi(LidoLocatorContract.abi_path),
        bytecode=LIDO_LOCATOR_BYTECODE,
    )

    tx_hash = locator_contract.constructor([
        web3_lido_integration.lido.lido_locator.functions.accountingOracle().call(),
        dsm_address,
        web3_lido_integration.lido.lido_locator.functions.elRewardsVault().call(),
        web3_lido_integration.lido.lido_locator.functions.legacyOracle().call(),
        web3_lido_integration.lido.lido_locator.functions.lido().call(),
        web3_lido_integration.lido.lido_locator.functions.oracleReportSanityChecker().call(),
        web3_lido_integration.lido.lido_locator.functions.postTokenRebaseReceiver().call(),
        web3_lido_integration.lido.lido_locator.functions.burner().call(),
        web3_lido_integration.lido.lido_locator.functions.stakingRouter().call(),
        web3_lido_integration.lido.lido_locator.functions.treasury().call(),
        web3_lido_integration.lido.lido_locator.functions.validatorsExitBusOracle().call(),
        web3_lido_integration.lido.lido_locator.functions.withdrawalQueue().call(),
        web3_lido_integration.lido.lido_locator.functions.withdrawalVault().call(),
        web3_lido_integration.lido.lido_locator.functions.oracleDaemonConfig().call(),
    ]).transact()
    tx_receipt = web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)
    new_locator = tx_receipt.contractAddress

    proxy = web3_lido_integration.eth.contract(
        address=variables.LIDO_LOCATOR,
        abi=web3_lido_integration.lido.lido_locator.load_abi('./interfaces/Proxy.json'),
    )

    admin = proxy.functions.proxy__getAdmin().call()

    web3_lido_integration.provider.make_request('anvil_setBalance', [admin, 10 ** 18])

    tx_hash = proxy.functions.proxy__upgradeTo(new_locator).transact({'from': admin})
    web3_lido_integration.eth.wait_for_transaction_receipt(tx_hash)

    assert web3_lido_integration.lido.has_contract_address_changed()
